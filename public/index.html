<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garage Connecté</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; width: 320px; }
        h1 { color: #333; margin-bottom: 5px; }
        .status-badge { display: inline-block; padding: 5px 15px; border-radius: 50px; font-weight: bold; margin-bottom: 20px; text-transform: uppercase; font-size: 0.9rem; }
        .closed { background-color: #d1fae5; color: #065f46; } /* Vert */
        .open { background-color: #fee2e2; color: #991b1b; }   /* Rouge */
        
        .btn-main {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none; border-radius: 50%; width: 150px; height: 150px; color: white;
            font-size: 1.2rem; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4); margin-bottom: 20px; outline: none;
            display: flex; align-items: center; justify-content: center; margin: 0 auto 20px auto;
        }
        .btn-main:active { transform: scale(0.95); box-shadow: 0 2px 8px rgba(118, 75, 162, 0.4); }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: left; font-size: 0.85rem; color: #666; background: #f8f9fa; padding: 15px; border-radius: 10px; }
        .info-item strong { display: block; color: #333; }
        
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 2s linear infinite; display: none; margin: 0 auto 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="card">
    <h1>Garage</h1>
    <div id="statusBadge" class="status-badge closed">Chargement...</div>
    
    <div class="loader" id="loader"></div>

    <button class="btn-main" onclick="toggleDoor()" id="actionBtn">
        ACTIONNER
    </button>

    <div class="info-grid">
        <div class="info-item">
            <strong>Batterie</strong>
            <span id="batteryLevel">--</span>%
        </div>
        <div class="info-item">
            <strong>Contacteur</strong>
            <span id="contactState">--</span>
        </div>
        <div class="info-item">
            <strong>Dernière Info</strong>
            <span id="lastAction">--</span>
        </div>
    </div>
</div>

<script>
    // Netlify gère la redirection api
    const API_URL = '/api';
    
    // Variable pour se souvenir si c'est ouvert ou fermé
    let isGarageClosed = true; 

    async function fetchStatus() {
        try {
            const response = await fetch(`${API_URL}/status`);
            if (!response.ok) throw new Error('Erreur réseau');
            const json = await response.json();
            
            if (json.result) {
                updateUI(json.result);
            }
        } catch (error) {
            console.error("Erreur de connexion", error);
        }
    }

    function updateUI(data) {
        // Récupération des données Tuya
        const contactState = data.find(item => item.code === 'doorcontact_state');
        const battery = data.find(item => item.code === 'battery_percentage');
        const doorState = data.find(item => item.code === 'door_state_1');

        const badge = document.getElementById('statusBadge');
        const contactText = document.getElementById('contactState');
        const btn = document.getElementById('actionBtn');
        
        // Logique État
        if (contactState) {
            // True = Contact Collé = Fermé
            isGarageClosed = (contactState.value === true);
            
            badge.textContent = isGarageClosed ? 'FERMÉ' : 'OUVERT';
            badge.className = `status-badge ${isGarageClosed ? 'closed' : 'open'}`;
            contactText.textContent = isGarageClosed ? 'Fermé' : 'Ouvert';

            // Change le texte du bouton selon l'état
            btn.textContent = isGarageClosed ? 'OUVRIR' : 'FERMER';
        }

        if (battery) {
            document.getElementById('batteryLevel').textContent = battery.value;
        }

        if (doorState) {
            document.getElementById('lastAction').textContent = doorState.value;
        }
    }

    async function toggleDoor() {
        const loader = document.getElementById('loader');
        loader.style.display = 'block';
        
        // LOGIQUE INTELLIGENTE :
        // Si c'est fermé, on envoie 'open'. Sinon on envoie 'close'.
        // On utilise le code 'door_control_1' qui est plus fiable pour les garages.
        const commandValue = isGarageClosed ? 'open' : 'close';

        console.log("Tentative d'action :", commandValue);

        try {
            const response = await fetch(`${API_URL}/command`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    code: 'door_control_1', 
                    value: commandValue 
                })
            });
            
            const result = await response.json();
            console.log("Réponse serveur :", result);

            if (!result.success) {
                console.warn("Le serveur Tuya a renvoyé une erreur ou false", result);
            }
            
            // On attend un peu et on rafraichit
            setTimeout(fetchStatus, 2000);
            
        } catch (error) {
            alert('Erreur lors de la commande (Vérifiez la console)');
            console.error(error);
        } finally {
            loader.style.display = 'none';
        }
    }

    // Premier chargement
    fetchStatus();
    // Rafraichissement automatique
    setInterval(fetchStatus, 5000);

</script>
</body>
</html>
